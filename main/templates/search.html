<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hledání {{ text }}</title>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    {% load static %}
        <link rel="stylesheet" href="{% static 'style.css' %}" type="text/css" />
    <link href="{% static 'assets/dist/css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style.css' %}">
  </head>
  <body>
        <header>
    <div class="px-1 py-2 bg-dark text-white">
      <div class="container">
        <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
          <a href="{% url 'index' %}" class="align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none" id="header">
              <img src="/media/icon/icon.png" alt="Icon" width="40" height="32">
          </a>
          <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small" id="icons">
            <li>
              <a href="{% url 'index' %}" class="nav-link text-white">
                <svg viewBox="0 1 511 511.999" class="bi d-block mx-auto mb-1" width="24" height="24">
                    <path fill="white"
                         d="m498.699219 222.695312c-.015625-.011718-.027344-.027343-.039063-.039062l-208.855468-208.847656c-8.902344-8.90625-20.738282-13.808594-33.328126-13.808594-12.589843 0-24.425781 4.902344-33.332031 13.808594l-208.746093 208.742187c-.070313.070313-.144532.144531-.210938.214844-18.28125 18.386719-18.25 48.21875.089844 66.558594 8.378906 8.382812 19.441406 13.234375 31.273437 13.746093.484375.046876.96875.070313 1.457031.070313h8.320313v153.695313c0 30.417968 24.75 55.164062 55.167969 55.164062h81.710937c8.285157 0 15-6.71875 15-15v-120.5c0-13.878906 11.292969-25.167969 25.171875-25.167969h48.195313c13.878906 0 25.167969 11.289063 25.167969 25.167969v120.5c0 8.28125 6.714843 15 15 15h81.710937c30.421875 0 55.167969-24.746094 55.167969-55.164062v-153.695313h7.71875c12.585937 0 24.421875-4.902344 33.332031-13.8125 18.359375-18.367187 18.367187-48.253906.027344-66.632813zm-21.242188 45.421876c-3.238281 3.238281-7.542969 5.023437-12.117187 5.023437h-22.71875c-8.285156 0-15 6.714844-15 15v168.695313c0 13.875-11.289063 25.164062-25.167969 25.164062h-66.710937v-105.5c0-30.417969-24.746094-55.167969-55.167969-55.167969h-48.195313c-30.421875 0-55.171875 24.75-55.171875 55.167969v105.5h-66.710937c-13.875 0-25.167969-11.289062-25.167969-25.164062v-168.695313c0-8.285156-6.714844-15-15-15h-22.328125c-.234375-.015625-.464844-.027344-.703125-.03125-4.46875-.078125-8.660156-1.851563-11.800781-4.996094-6.679688-6.679687-6.679688-17.550781 0-24.234375.003906 0 .003906-.003906.007812-.007812l.011719-.011719 208.847656-208.839844c3.234375-3.238281 7.535157-5.019531 12.113281-5.019531 4.574219 0 8.875 1.78125 12.113282 5.019531l208.800781 208.796875c.03125.03125.066406.0625.097656.09375 6.644531 6.691406 6.632813 17.539063-.03125 24.207032zm0 0"
                         id="path2"/>
                </svg>
                Přehled
              </a>
            </li>

            <li>
                {% if user.is_authenticated %}
                  <a href="{% url 'log_out' %}" class="nav-link text-secondary" style="cursor: pointer;" data-hover="Odhlásit se">
                <svg class="bi d-block mx-auto mb-1" height="24" viewBox="0 0 512 512" width="24">
                  <path fill="gray"
                     d="m437.019531 74.980469c-48.351562-48.351563-112.640625-74.980469-181.019531-74.980469-68.382812 0-132.667969 26.628906-181.019531 74.980469-48.351563 48.351562-74.980469 112.636719-74.980469 181.019531 0 68.378906 26.628906 132.667969 74.980469 181.019531 48.351562 48.351563 112.636719 74.980469 181.019531 74.980469 68.378906 0 132.667969-26.628906 181.019531-74.980469 48.351563-48.351562 74.980469-112.640625 74.980469-181.019531 0-68.382812-26.628906-132.667969-74.980469-181.019531zm-308.679687 367.40625c10.707031-61.648438 64.128906-107.121094 127.660156-107.121094 63.535156 0 116.953125 45.472656 127.660156 107.121094-36.347656 24.972656-80.324218 39.613281-127.660156 39.613281s-91.3125-14.640625-127.660156-39.613281zm46.261718-218.519531c0-44.886719 36.515626-81.398438 81.398438-81.398438s81.398438 36.515625 81.398438 81.398438c0 44.882812-36.515626 81.398437-81.398438 81.398437s-81.398438-36.515625-81.398438-81.398437zm235.042969 197.710937c-8.074219-28.699219-24.109375-54.738281-46.585937-75.078125-13.789063-12.480469-29.484375-22.328125-46.359375-29.269531 30.5-19.894531 50.703125-54.3125 50.703125-93.363281 0-61.425782-49.976563-111.398438-111.402344-111.398438s-111.398438 49.972656-111.398438 111.398438c0 39.050781 20.203126 73.46875 50.699219 93.363281-16.871093 6.941406-32.570312 16.785156-46.359375 29.265625-22.472656 20.339844-38.511718 46.378906-46.585937 75.078125-44.472657-41.300781-72.355469-100.238281-72.355469-165.574219 0-124.617188 101.382812-226 226-226s226 101.382812 226 226c0 65.339844-27.882812 124.277344-72.355469 165.578125zm0 0"
                     id="path2"/>
                </svg>
                      {{ user.first_name }} {{ user.last_name }}
                </a>
            {% else %}
                 <a onclick="Log_in_Modal.show();" class="nav-link text-secondary" style="cursor: pointer;">
                <svg class="bi d-block mx-auto mb-1" height="24" viewBox="0 0 512 512" width="24">
                  <path fill="gray"
                     d="m437.019531 74.980469c-48.351562-48.351563-112.640625-74.980469-181.019531-74.980469-68.382812 0-132.667969 26.628906-181.019531 74.980469-48.351563 48.351562-74.980469 112.636719-74.980469 181.019531 0 68.378906 26.628906 132.667969 74.980469 181.019531 48.351562 48.351563 112.636719 74.980469 181.019531 74.980469 68.378906 0 132.667969-26.628906 181.019531-74.980469 48.351563-48.351562 74.980469-112.640625 74.980469-181.019531 0-68.382812-26.628906-132.667969-74.980469-181.019531zm-308.679687 367.40625c10.707031-61.648438 64.128906-107.121094 127.660156-107.121094 63.535156 0 116.953125 45.472656 127.660156 107.121094-36.347656 24.972656-80.324218 39.613281-127.660156 39.613281s-91.3125-14.640625-127.660156-39.613281zm46.261718-218.519531c0-44.886719 36.515626-81.398438 81.398438-81.398438s81.398438 36.515625 81.398438 81.398438c0 44.882812-36.515626 81.398437-81.398438 81.398437s-81.398438-36.515625-81.398438-81.398437zm235.042969 197.710937c-8.074219-28.699219-24.109375-54.738281-46.585937-75.078125-13.789063-12.480469-29.484375-22.328125-46.359375-29.269531 30.5-19.894531 50.703125-54.3125 50.703125-93.363281 0-61.425782-49.976563-111.398438-111.402344-111.398438s-111.398438 49.972656-111.398438 111.398438c0 39.050781 20.203126 73.46875 50.699219 93.363281-16.871093 6.941406-32.570312 16.785156-46.359375 29.265625-22.472656 20.339844-38.511718 46.378906-46.585937 75.078125-44.472657-41.300781-72.355469-100.238281-72.355469-165.574219 0-124.617188 101.382812-226 226-226s226 101.382812 226 226c0 65.339844-27.882812 124.277344-72.355469 165.578125zm0 0"
                     id="path2"/>
                </svg>
                    Přihlaste se
                  </a>
                {% endif %}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </header>

<div class="container" style="padding-top: 20px;">
    <h1>Výsledky hledání {{ text }}</h1>
<h2>Všichni</h2>
    <form class="search" method="get" action="{% url 'search' %}">
        <input type="text" class="search-input" placeholder="Vyhledejte podle jména, přijmení nebo postavení..." name="text" value="{{ text }}">
        <input type="submit" class="search-icon" value="Hledat">
    </form>
    <table class="table" id="all">
      <thead>
        <tr>
          <th scope="col">Jméno</th>
          <th scope="col">Přijmení</th>
          <th scope="col">Postavení</th>
          <th scope="col">Přímluvci</th>
        </tr>
      </thead>
      <tbody>
      {% for i in all %}
        <tr>
          <td>{{ i.name }}</td>
          <td>{{ i.surname }}</td>
          <td>{{ i.position }}</td>
            <td>{% if user.is_authenticated %}<button onclick="add_me({{ i.id }})" type="button" class="btn btn-primary">Přidat se k</button>
                <span
                    onclick="load_data({{ i.id }}); Detail_Modal.show();" class="badge bg-secondary" id="span_{{ i.id }}">{{ i.intercessors.all|length}}</span>
            {% else %}
                <button class="btn btn-secondary" onclick="load_data({{ i.id }}); Detail_Modal.show();">{{ i.intercessors.all|length}}</button>
            {% endif %}
            </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
</div>

  <div class="modal fade" tabindex="-1" role="dialog" id="modalDetail">
  <div class="modal-dialog" role="document">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-body p-5">
        <h2 class="fw-bold mb-0" style="color: black;">Detail</h2>

        <ul class="d-grid gap-4 my-5 list-unstyled">
          <li class="d-flex gap-4">
            <div>
              <h5 class="mb-0" style="color: black;" id="who">Kdo</h5>
            </div>
          </li>
          <li class="d-flex gap-4">
            <div>
              <h5 class="mb-0" style="color: black;" id="status">Funkce</h5>
            </div>
          </li>
          <li class="d-flex gap-4">
            <div>
              <h5 class="mb-0" style="color: black;">Přímluvci</h5>
                <p style="color: black;" id="intercessors">.</p>
            </div>
          </li>
        </ul>
        <button type="button" class="btn btn-lg btn-primary mt-5 w-100" data-bs-dismiss="modal">Zavřít!</button>
      </div>
    </div>
  </div>
</div>
  <script>
      var Detail_Modal = new bootstrap.Modal(document.getElementById('modalDetail'));
      function load_data(id) {
          $.ajax({
             type:'POST',
             url:'{% url 'load_details' %}',
             data:{
                 'id': id,
                 'csrfmiddlewaretoken':'{{ csrf_token }}'
             },
             success: function (data) {
                      $('#who').text(`${data.name}`);
                      $('#status').text(`${data.position}`);
                      $('#intercessors').text('');
                      for (var i = 0; i < data.intercessors.length; i++) {
                          $('#intercessors').append(`${data.intercessors[i].first_name} ${data.intercessors[i].last_name}<br>`);
                      }
             },
                error: function (edata) {
                    ErrorModal.show();
                }
        })
      }


      function add_me(id) {
        $.ajax({
             type:'POST',
             url:'{% url 'add_me' %}',
             data:{
                 'id': id,
                 'csrfmiddlewaretoken':'{{ csrf_token }}'
             },
             success: function (data) {
                 if (data.yet) {
                     alert("Za tohoto politika se už přimlouváte");
                 } else {
                     //Přidat do tabulky a do span_{{ i.id }}
                     $('#tbody').append(`<tr id="my_${id}">
                          <td>${data.name}</td>
                          <td>${data.surname}</td>
                          <td>${data.position}</td>
                          <td><button onclick="remove_me(${id})" type="button" class="btn btn-danger">Odebrat</button></td>
                        </tr>`);
                     var count = $('#span_' + id).text();
                     console.log(count);
                     count = count.replace("\n", "");
                     count = count.replaceAll(" ", "");
                     count = parseInt(count);
                     count++;
                     console.log(count);
                     $('#span_' + id).text(count.toString());
                     Info_Modal.show();
                 }
             },
                error: function (edata) {
                    ErrorModal.show();
                }
        })
      }
      function remove_me(id) {
        $.ajax({
             type:'POST',
             url:'{% url 'remove_me' %}',
             data:{
                 'id': id,
                 'csrfmiddlewaretoken':'{{ csrf_token }}'
             },
             success: function (data) {
                //Odebrat z tabulky a ze span_{{ i.id }}
                 $('#my_'+id).remove();
                 var count = $('#span_'+id).text();
                 console.log(count);
                 count = count.replace("\n", "");
                 count = count.replaceAll(" ", "");
                 count = parseInt(count);
                 count--;
                 console.log(count);
                 $('#span_'+id).text(count.toString());
                 RemoveModal.show();
             },
                error: function (edata) {
                    ErrorModal.show();
                }
        })
      }
  </script>

<div class="modal fade" tabindex="-1" role="dialog" id="modalInfo">
  <div class="modal-dialog" role="document">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-body p-5">
        <h2 class="fw-bold mb-0" style="color: black;">Přidali jste se!</h2>

        <ul class="d-grid gap-4 my-5 list-unstyled">
          <li class="d-flex gap-4">
            <div>
              <h5 class="mb-0" style="color: black;">Děkujeme!</h5>
            </div>
          </li>
        </ul>
        <button type="button" class="btn btn-lg btn-primary mt-5 w-100" data-bs-dismiss="modal">Dobře!</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="modalRemove">
  <div class="modal-dialog" role="document">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-body p-5">
        <h2 class="fw-bold mb-0" style="color: black;">Odebrali jste se!</h2>

        <ul class="d-grid gap-4 my-5 list-unstyled">
          <li class="d-flex gap-4">
            <div>
              <h5 class="mb-0" style="color: black;">Už se nepřimlouváte</h5>
            </div>
          </li>
        </ul>
        <button type="button" class="btn btn-lg btn-primary mt-5 w-100" data-bs-dismiss="modal">Zavřít!</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="modalError">
  <div class="modal-dialog" role="document">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-body p-5">
        <h2 class="fw-bold mb-0" style="color: black;">Chyba!</h2>

        <ul class="d-grid gap-4 my-5 list-unstyled">
          <li class="d-flex gap-4">
            <div>
              <h5 class="mb-0" style="color: black;">Zkontrolujte prosím internetové připojení</h5>
            </div>
          </li>
        </ul>
        <button type="button" class="btn btn-lg btn-primary mt-5 w-100" data-bs-dismiss="modal">Dobře!</button>
      </div>
    </div>
  </div>
</div>
  <script>
      var Info_Modal = new bootstrap.Modal(document.getElementById('modalInfo'));
      var RemoveModal = new bootstrap.Modal(document.getElementById('modalRemove'));
      var ErrorModal = new bootstrap.Modal(document.getElementById('modalError'));
  </script>

</body>
</html>